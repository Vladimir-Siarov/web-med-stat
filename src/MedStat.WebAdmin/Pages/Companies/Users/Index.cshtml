@page "/Companies/{CompanyId:int}/Users/"

@using MedStat.WebAdmin.Classes
@using MedStat.WebAdmin.Classes.SharedResources
@using MedStat.WebAdmin.Models
@using Microsoft.AspNetCore.Mvc.Localization

@model CompanyUsersPageModel

@inject IHtmlLocalizer<CompanyResource> CmpLocalizer
@inject IHtmlLocalizer<IdentityResource> IdentityLocalizer
@inject IHtmlLocalizer<DialogResources> DlgLocalizer

@{
	Layout = "_CompanyLayout";

	ViewData.SetDataTablePageFlag();

	var userSearchPanelModel = new DataTableSearchPanelModel("tblCmpUsers");
}

<div class="ms-pagecontent">

	<div class="ms-section-header">
		<div>
			<button id="btnCreateNewCmpUser" class="btn btn-success btn-sm">
				<svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-plus" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
					<path fill-rule="evenodd" d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z" />
				</svg>@CmpLocalizer["Create user"]
			</button>
		</div>

		<partial name="_DtSearchPanelPartial" model="@userSearchPanelModel" />
	</div>


	<table id="tblCmpUsers"
				 class="table table-hover caption-top" style="width: 100%"
				 data-ajax="@(Url.Page("/Companies/Users/", "CompanyUserList", new { CompanyId = Model.CompanyId }))"
				 data-auto-width="false"
				 data-ms-page-length-control="#@userSearchPanelModel.PageLengthControlId"
				 data-ms-search-control="#@userSearchPanelModel.SearchControlId"
				 ms-datatable>
		<caption>@CmpLocalizer["List of users"]</caption>
		<thead>
			<tr>
				<th data-data="id" data-width="5%">Id</th>
				<th data-data="Surname" data-width="15%">@IdentityLocalizer["Surname"]</th>
				<th data-data="FirstName" data-width="15%">@IdentityLocalizer["FirstName"]</th>
				<th data-data="Patronymic" data-width="15%">@IdentityLocalizer["Patronymic"]</th>
				<th data-data="PhoneNumber" data-width="15%">@IdentityLocalizer["PhoneNumber"]</th>
				<th data-data="description" data-width="30%" data-ms-max-length="100">@CmpLocalizer["Description"]</th>
				<th data-width="5%"><!-- actions --></th>
			</tr>
		</thead>
	</table>

	<div id="tblCompanies_linkTemplate" style="display: none">
		@{
			string companyUrl = Url.Page("/Companies/Main", new { CompanyId = "-1" })
				.Replace("-1", "{id}");
		}
		<a href="@(companyUrl)">{name}</a>
	</div>


	@* Modal Popup *@
	<div id="modalUser" class="modal fade" tabindex="-1" aria-labelledby="modalUser_label" aria-hidden="true">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h3 class="modal-title" id="modalUser_label">@DlgLocalizer["Delete confirmation"]</h3>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="@DlgLocalizer["Close"]"></button>
				</div>
				<div class="modal-body">

					<iframe id="modalUser_iframe" src="about:blank" style="width: 100%; height: 100%; border:none"></iframe>

				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
						@DlgLocalizer["Close"]
					</button>
				</div>
			</div>
		</div>
	</div>

</div>


@section Scripts
{
	<script type="text/javascript">

		window.pageInit = function() {

			var userModal = null;

			var openCmpUserPopup = function(userId) {

				$('#modalUser_label').text(userId ? 'Edit user' : '@CmpLocalizer["New user"]');
				$('#modalUser_iframe').get(0).contentDocument.body.innerHTML = '@DlgLocalizer["Loading..."]';

				if (userModal == null) {
					userModal = new bootstrap.Modal(document.getElementById('modalUser'),
						{
							focus: true
						});
				}

				userModal.show();

				if (userId) {
				}
				else {
					$('#modalUser_iframe').get(0).src = '@Url.Page("./Create", new {CompanyId = Model.CompanyId})';
				}
			};


			$('#btnCreateNewCmpUser').click(function() {

				openCmpUserPopup();
			});

			$('#modalUser_iframe').get(0).addEventListener("load",
				function(e) {

					$(this).height($(this.contentDocument.body).height());
				});

		};

	</script>
}