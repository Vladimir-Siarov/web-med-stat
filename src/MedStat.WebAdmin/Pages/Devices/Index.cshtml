@page
@using MedStat.WebAdmin.Classes
@using MedStat.WebAdmin.Classes.Helpers
@using MedStat.WebAdmin.Classes.SharedResources
@using MedStat.WebAdmin.Models
@using Microsoft.AspNetCore.Mvc.Localization
@using Microsoft.Extensions.Localization

@model DeviceListModel

@inject IHtmlLocalizer<DeviceResource> DvLocalizer
@inject IStringLocalizer<DialogResources> DlgLocalizer

@{
	var pageTitle = DvLocalizer["__pageTitle__Device list"];
	var pageTitleShort = DvLocalizer["__pageTitle__List"];

	ViewData["Title"] = pageTitle.Value;
	ViewData.SetSelectedMainMenu(NavHelper.EnMainMenuItem.DeviceList);
	ViewData.SetDataTablePageFlag();

	var deviceSearchPanelModel = new DataTableSearchPanelModel("tblDevices");

	var deviceDialogModel = new PopupDialogModel(DlgLocalizer)
	{
		ControlId = "dlgDevice",
		IsLarge = true
	};
	var deviceDeleteDialogModel = new PopupDialogModel(DlgLocalizer)
	{
		ControlId = "dlgDeviceDelete",
		IsDangerAction = true
	};
}


@section PageHeader
{
	<nav aria-label="breadcrumb">
		<breadcrumb menu-item="@NavHelper.EnMainMenuItem.DeviceList"
								page-title="@pageTitleShort.Value"></breadcrumb>
	</nav>

	<h1 class="ms-pageheader-pagetitle">@pageTitle</h1>
}

<div class="ms-pagecontent">

	<div class="ms-section-header">
		<div>
			<button id="btnCreateDevice" class="btn btn-success btn-sm" data-action="create">
				<svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-plus" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
					<path fill-rule="evenodd" d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z" />
				</svg>@DvLocalizer["__btn__Create device"]
			</button>
		</div>
		
		<partial name="_DtSearchPanelPartial" model="@deviceSearchPanelModel" />
		
	</div>
	
	<table id="tblDevices"
				 class="table table-hover caption-top" style="width: 100%"
				 data-ajax="@(Url.PageLink("Index", "DeviceList"))"
				 data-auto-width="false"
				 data-ms-page-length-control="#@(deviceSearchPanelModel.PageLengthControlId)"
				 data-ms-search-control="#@(deviceSearchPanelModel.SearchControlId)">
		<caption>@DvLocalizer["Device list"]</caption>
		<thead>
			<tr>
				<th data-data="id" data-width="5%">Id</th>
				<th data-data="inventoryNumber" data-width="20%">@DvLocalizer["__DeviceGrid_Column__InventoryNumber"]</th>
				<th data-data="wifiMac" data-width="20%">@DvLocalizer["__DeviceGrid_Column__WifiMac"]</th>
				<th data-data="ethernetMac" data-width="20%">@DvLocalizer["__DeviceGrid_Column__EthernetMac"]</th>
				<th data-data="modelName" data-orderable="false" data-width="20%">@DvLocalizer["__ModelGrid_Column__Model"]</th>
				<th data-data="type" data-orderable="false" data-width="10%" data-ms-html-template="#tblDevices_typeTemplate">@DvLocalizer["__ModelGrid_Column__Type"]</th>
				<th data-orderable="false" data-width="5%" data-class-name="buttons" data-ms-html-template="#tblDevices_buttonsTemplate">
					<!-- buttons -->
				</th>
			</tr>
		</thead>
	</table>

	<div id="tblDevices_typeTemplate" style="display: none">
		<span class="ms-datable-icon" data-device-type="{type}"></span>
	</div>
	
	<div id="tblDevices_buttonsTemplate" style="display: none">
		<button type="button" class="btn btn-link" title="@DvLocalizer["__DeviceGrid_Button__Edit"]"
		        data-action="edit" data-device-id="{id}">
			<span class="ms-datable-icon ms-icon-grid-edit"></span>
			<span class="visually-hidden">@DvLocalizer["__DeviceGrid_Button__Edit"]</span>
		</button>

		<button type="button" class="btn btn-link" title="@DvLocalizer["__DeviceGrid_Button__Delete"]"
		        data-action="delete" data-device-id="{id}">
			<span class="ms-datable-icon ms-icon-grid-delete"></span>
			<span class="visually-hidden">@DvLocalizer["__DeviceGrid_Button__Delete"]</span>
		</button>
	</div>


	@* Device Popup *@
	<partial name="_PopupDialogPartial" model="@deviceDialogModel" />
	
	@* Delete confirmation popup *@
	<partial name="_PopupDialogPartial" model="@deviceDeleteDialogModel" />

</div>



@section Scripts
{
	<script type="text/javascript">

		window.pageInit = function() {

			// Popup functionality:

			var deviceDialog = new window.ms.PopupDialogClass(@(Html.Raw(Json.Serialize(deviceDialogModel)))).init();
			var deviceDeleteDialog = new window.ms.PopupDialogClass(@(Html.Raw(Json.Serialize(deviceDeleteDialogModel)))).init();

			var openDevicePopup = function(deviceId) {

				var contentUrl = deviceId
					? '@Url.Page("./Edit", new {DeviceId = -1})'.replace('-1', deviceId)
					: '@Url.Page("./Create")';

				deviceDialog.show(contentUrl);
			};
			var openDeviceDeletePopup = function(deviceId) {

				var contentUrl = '@Url.Page("./Delete", new {DeviceId = -1})'.replace('-1', deviceId);

				deviceDeleteDialog.show(contentUrl);
			};

			$(window).bind('ms_popup_entityWasCreated ms_popup_entityWasUpdated ms_popup_entityWasDeleted',
				function(e, popupParams) {

					$('#tblDevices').DataTable().draw('full-hold');
				});


			// Grid functionality:

			var deviceTypes = @(Html.Raw(Json.Serialize(DeviceHelper.GetDeviceTypeInfoList(DvLocalizer))));
			
			var onDeviceActionBtnClick = function() {

				var deviceId = $(this).attr('data-device-id');
				var action = $(this).attr('data-action');

				switch (action) {

					case 'create':
						openDevicePopup(null);
						break;

					case 'edit':
						openDevicePopup(deviceId);
						break;

					case 'delete':
						openDeviceDeletePopup(deviceId);
						break;

					default:
						throw 'unsupported device action button: ' + action;
				}
			};

			$('#btnCreateDevice').click(onDeviceActionBtnClick);

			$('#tblDevices')
				.on('draw.dt', function() {

					// init grid buttons
					$('#tblDevices button').click(onDeviceActionBtnClick);

					// init Grid icons
					$('#tblDevices [data-device-type]').each(function() {

						var $t = $(this);
						var type = deviceTypes.find(t => t.type === $t.attr('data-device-type'));

						if (type != null) {
							$t.addClass(type.iconCss).attr('title', type.title);
						} 
						else {
							throw 'Device type "' + $t.attr('data-device-type') + '" is not supported.';
						}
					});
				})
				.msDataTable(); // init grid
		};

	</script>
}